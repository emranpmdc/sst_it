<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Computer Fundamentals Quiz - SST Tests Preparation</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas CDN for converting HTML to image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom font for Georgia */
        @font-face {
            font-family: 'Georgia';
            src: local('Georgia'), url('https://fonts.googleapis.com/css2?family=Georgia&display=swap') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        /* Custom font for Inter (for header/footer) */
        @font-face {
            font-family: 'Inter';
            src: local('Inter'), url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Georgia', serif; /* Default font for the entire page */
            background-color: #f0f4f8; /* Light background */
            color: #333;
        }

        /* Apply Inter font to header and footer elements */
        header, footer {
            font-family: 'Inter', sans-serif;
        }

        /* Specific style for question text - already Georgia, but keeping for emphasis */
        .question-text {
            font-family: 'Georgia', serif;
            color: #dc2626; /* Red color */
            font-size: 1.25rem; /* Equivalent to text-xl in Tailwind */
            font-weight: bold;
        }

        /* Style for radio button labels to make them long and clear */
        .option-label {
            display: block; /* Make label take full width */
            padding: 0.75rem 1rem; /* Padding for click area */
            margin-bottom: 0.5rem; /* Space between options */
            background-color: #e2e8f0; /* Light grey background */
            border-radius: 0.5rem; /* Rounded corners */
            cursor: pointer; /* Pointer cursor on hover */
            transition: background-color 0.2s ease-in-out;
            font-size: 1rem; /* Standard text size */
            color: #1a202c; /* Dark text color */
            border: 1px solid #cbd5e0; /* Light border */
        }

        .option-label:hover {
            background-color: #cbd5e0; /* Darker grey on hover */
        }

        /* Hide default radio button */
        .option-input {
            display: none;
        }

        /* Style for selected radio button */
        .option-input:checked + .option-label {
            background-color: #3b82f6; /* Blue background for selected */
            color: #ffffff; /* White text for selected */
            border-color: #2563eb; /* Darker blue border */
        }

        /* Style for the custom message box (instead of alert) */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fee2e2; /* Light red background */
            border: 1px solid #ef4444; /* Red border */
            color: #b91c1c; /* Dark red text */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
            font-weight: bold;
            display: none; /* Hidden by default */
        }

        .message-box button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
        }

        /* Styling for scroll button */
        #scroll-button {
            position: fixed;
            right: 1rem;
            bottom: 2rem;
            background-color: #10B981; /* Green-500 */
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 9999px; /* Full rounded */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            font-weight: bold;
            display: flex; /* Use flexbox for icon centering */
            align-items: center;
            justify-content: center;
            width: 50px; /* Fixed width for circular button */
            height: 50px; /* Fixed height for circular button */
        }

        #scroll-button:hover {
            background-color: #059669; /* Green-600 */
            transform: scale(1.05);
        }

        /* Adjust main content padding - removed fixed header padding */
        main {
            padding-top: 1rem; /* Default padding */
        }

        /* Styling for the hidden printable area */
        #printable-results-image {
            background-color: #ffffff;
            padding: 20px;
            border: 1px solid #ccc;
            font-family: 'Inter', sans-serif; /* Apply Inter to the printable content */
            color: #333;
            width: 800px; /* Fixed width for the image content */
            margin: 0 auto; /* Center it for screenshot */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center; /* Center align all content within the image */
        }
        #printable-results-image .header-content,
        #printable-results-image .footer-content {
            background-color: #16a34a; /* Green-700 */
            color: white;
            padding: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        #printable-results-image .results-summary {
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center; /* Ensure results summary is centered */
        }
        #printable-results-image .results-summary strong {
            color: #16a34a; /* Green-700 */
        }
        #printable-results-image .date-time {
            text-align: right; /* Keep date/time right-aligned within its container */
            font-size: 0.9rem;
            color: #555;
            margin-top: 10px;
            padding-right: 20px; /* Add some padding to the right */
        }
        #printable-results-image .user-name-display {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #3b82f6; /* Blue color for name */
        }

        /* New Explanation Modal CSS */
        #explanation-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            /* Hidden by default, controlled by JS */
            display: none;
        }
        #explanation-modal > div {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 36rem; /* max-w-lg */
            width: 100%;
            margin: 1rem; /* mx-4 */
            position: relative;
        }
        #explanation-modal #close-explanation-modal {
            position: absolute;
            top: 0.75rem; /* top-3 */
            right: 0.75rem; /* right-3 */
            color: #6b7280; /* gray-500 */
            font-size: 2rem; /* text-2xl */
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        #explanation-modal #close-explanation-modal:hover {
            color: #1f2937; /* gray-800 */
        }
        #explanation-modal #explanation-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            color: #1f2937; /* gray-800 */
            margin-bottom: 1rem; /* mb-4 */
            border-bottom: 1px solid #e5e7eb; /* border-b pb-2 */
            padding-bottom: 0.5rem;
        }
        #explanation-modal #explanation-content {
            max-height: 24rem; /* max-h-96 */
            overflow-y: auto;
            color: #374151; /* gray-700 */
            padding-right: 0.5rem; /* To accommodate scrollbar */
            text-align: left; /* Keep explanation text left-aligned */
        }
        #explanation-modal #explanation-loading {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            /* Hidden by default, controlled by JS */
            display: none;
        }

        /* Spinner CSS */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* Blue for spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Welcome Screen */
        #welcome-screen {
            position: fixed;
            inset: 0;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000; /* Higher than other modals */
            text-align: center;
        }
        #welcome-screen .welcome-box {
            background-color: #ffffff;
            padding: 2.5rem; /* p-10 */
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); /* shadow-lg */
            max-width: 28rem; /* max-w-md */
            width: 90%;
            font-family: 'Inter', sans-serif;
        }
        #welcome-screen h2 {
            font-size: 2.25rem; /* text-4xl */
            font-weight: bold;
            color: #16a34a; /* green-700 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        #welcome-screen input[type="text"] {
            width: calc(100% - 2rem); /* full width minus padding */
            padding: 0.75rem 1rem; /* py-3 px-4 */
            border: 1px solid #cbd5e0; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1rem; /* text-lg */
            margin-bottom: 1.5rem; /* mb-6 */
            outline: none;
            transition: border-color 0.2s ease;
        }
        #welcome-screen input[type="text"]:focus {
            border-color: #3b82f6; /* blue-500 */
        }
        #welcome-screen button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.75rem 2rem; /* py-3 px-8 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1.125rem; /* text-xl */
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        #welcome-screen button:hover {
            background-color: #2563eb; /* blue-600 */
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Welcome Screen (Initial View) -->
    <div id="welcome-screen">
        <div class="welcome-box">
            <h2>Welcome to SST TESTs PREPARATION!</h2>
            <p class="mb-4 text-gray-700">Please enter your name to start the quiz:</p>
            <input type="text" id="user-name-input" placeholder="Your Name" class="focus:ring-2 focus:ring-blue-500">
            <button id="start-quiz-btn">Start Quiz</button>
        </div>
    </div>

    <!-- Main Quiz Content (Hidden initially) -->
    <div id="quiz-content" style="display: none;">
        <!-- Main Heading -->
        <header class="bg-green-700 text-white py-4 shadow-lg">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center tracking-wide">SST TESTs PREPARATION</h1>
            <div class="container mx-auto text-center text-sm md:text-base">
                <p class="mb-1">By Imran Ustad</p>
                <p class="mb-1">YouTube : <a href="https://www.youtube.com/@TheImranUstad" target="_blank" class="text-blue-200 hover:underline">Imran Ustad</a></p>
                <p>WhatsApp : 03345501369</p>
            </div>
        </header>

        <main class="flex-grow container mx-auto p-4 md:p-8">
            <!-- Timer Section - Reverted to old style, not fixed -->
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-md mb-6 flex items-center justify-between">
                <p class="font-bold text-lg">Time Remaining:</p>
                <div id="countdown-timer" class="text-2xl font-bold text-yellow-800 bg-yellow-200 px-4 py-2 rounded-md">00:00</div>
            </div>

            <!-- Quiz Questions Container -->
            <form id="quiz-form" class="space-y-6">
                <!-- Questions will be dynamically loaded here by JavaScript -->
            </form>

            <!-- Submit Button -->
            <div class="text-center mt-8">
                <button id="submit-quiz-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                    Submit Quiz
                </button>
            </div>

            <!-- YouTube Video Embed -->
            <div class="my-8 flex justify-center">
                <div class="relative w-full max-w-4xl" style="padding-bottom: 56.25%;">
                    <iframe class="absolute top-0 left-0 w-full h-full rounded-lg shadow-lg" src="https://www.youtube.com/embed/sFzdY39_Kw8" title="KPPSC SST Syllabus 2025 KPK | SST General, Maths-Physics, Bio-Chem | Past Papers &amp; Preparation Guide" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                </div>
            </div>

            <!-- Results Display Area -->
            <div id="results" class="hidden mt-8 p-6 bg-white rounded-lg shadow-xl border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Quiz Results</h2>
                <p class="text-lg mb-2">Total Questions: <strong id="total-questions" class="text-green-700"></strong></p>
                <p class="text-lg mb-4">Obtained Marks: <strong id="obtained-marks" class="text-green-700"></strong></p>
                <div id="incorrect-answers" class="mt-4">
                    <h3 class="text-xl font-bold text-red-600 mb-2">Incorrectly Answered Questions:</h3>
                    <ul id="incorrect-list" class="list-disc pl-5 space-y-2">
                        <!-- Incorrect questions details will be listed here -->
                    </ul>
                </div>
                <button id="print-results-btn" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                    Print Results
                </button>
            </div>
        </main>

        <!-- Custom Message Box -->
        <div id="message-box" class="message-box">
            <p id="message-text"></p>
            <button onclick="document.getElementById('message-box').style.display = 'none';">OK</button>
        </div>

        <!-- New Explanation Modal HTML -->
        <div id="explanation-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001] hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full mx-4 relative">
                <button id="close-explanation-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                <h3 id="explanation-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Explanation</h3>
                <div id="explanation-content" class="max-h-96 overflow-y-auto text-gray-700">
                    <!-- Explanation content will be loaded here -->
                </div>
                <div id="explanation-loading" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-content-center hidden">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Hidden div for generating image content -->
        <div id="printable-results-image" style="position: absolute; left: -9999px; top: -9999px; width: 800px;">
            <!-- Content will be dynamically added here for image generation -->
        </div>

        <!-- Single Scroll Button -->
        <button id="scroll-button" class="scroll-button">
            <!-- Default icon for scroll to bottom -->
            <svg id="scroll-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
        </button>

        <!-- Footer -->
        <footer class="bg-green-700 text-white py-6 mt-auto shadow-inner">
            <div class="container mx-auto text-center">
                <h3 class="text-md md:text-lg font-semibold mb-2">By Imran Ustad</h3>
                <p class="text-sm mb-1">YouTube : <a href="https://www.youtube.com/@TheImranUstad" target="_blank" class="text-blue-200 hover:underline">Imran Ustad</a></p>
                <p class="text-sm mb-4">WhatsApp : 03345501369</p>
            </div>
        </footer>
    </div> <!-- End of quiz-content -->

    <script>
        // Array of 30 new MCQs
        const questions = [
            {
                question: "What is the primary function of the Central Processing Unit (CPU) in a computer?",
                options: ["To store data permanently", "To execute program instructions", "To display output on the screen", "To manage the power supply"],
                answer: "To execute program instructions"
            },
            {
                question: "Which of the following is considered the 'brain' of the computer?",
                options: ["RAM", "Monitor", "CPU", "Hard Drive"],
                answer: "CPU"
            },
            {
                question: "What does RAM stand for?",
                options: ["Random Access Memory", "Read-Only Memory", "Running Access Module", "Remote Access Memory"],
                answer: "Random Access Memory"
            },
            {
                question: "Which of these is a type of permanent storage?",
                options: ["RAM", "Cache Memory", "Hard Disk Drive", "Registers"],
                answer: "Hard Disk Drive"
            },
            {
                question: "A set of instructions that a computer follows is known as:",
                options: ["Hardware", "Software", "Motherboard", "Firmware"],
                answer: "Software"
            },
            {
                question: "The operating system is an example of what type of software?",
                options: ["Application Software", "Utility Software", "System Software", "Malware"],
                answer: "System Software"
            },
            {
                question: "Which of the following is an input device?",
                options: ["Monitor", "Printer", "Keyboard", "Speaker"],
                answer: "Keyboard"
            },
            {
                question: "Which of the following is an output device?",
                options: ["Mouse", "Scanner", "Microphone", "Printer"],
                answer: "Printer"
            },
            {
                question: "The smallest unit of data in a computer is a:",
                options: ["Byte", "Kilobyte", "Bit", "Gigabyte"],
                answer: "Bit"
            },
            {
                question: "A collection of 8 bits is called a:",
                options: ["Byte", "Nibble", "Word", "Kilobyte"],
                answer: "Byte"
            },
            {
                question: "What is the full form of ROM?",
                options: ["Read-Only Memory", "Random Output Module", "Running Operating Module", "Remote Order Memory"],
                answer: "Read-Only Memory"
            },
            {
                question: "Which computer generation used vacuum tubes?",
                options: ["First Generation", "Second Generation", "Third Generation", "Fourth Generation"],
                answer: "First Generation"
            },
            {
                question: "Who is known as the 'Father of the Computer'?",
                options: ["Bill Gates", "Charles Babbage", "Alan Turing", "Steve Jobs"],
                answer: "Charles Babbage"
            },
            {
                question: "What is the main circuit board of a computer called?",
                options: ["Hard Disk", "CPU", "Motherboard", "RAM"],
                answer: "Motherboard"
            },
            {
                question: "What is a program that a user interacts with to perform a specific task, such as a word processor?",
                options: ["Operating System", "System Software", "Device Driver", "Application Software"],
                answer: "Application Software"
            },
            {
                question: "Which of these is a volatile memory?",
                options: ["ROM", "Hard Disk", "Flash Drive", "RAM"],
                answer: "RAM"
            },
            {
                question: "The process of starting or restarting a computer is called:",
                options: ["Hibernation", "Booting", "Processing", "Formatting"],
                answer: "Booting"
            },
            {
                question: "What is the purpose of a firewall?",
                options: ["To cool down the computer", "To protect against unauthorized access", "To speed up internet connection", "To clean up disk space"],
                answer: "To protect against unauthorized access"
            },
            {
                question: "What does 'WWW' stand for?",
                options: ["World Wide Web", "World Wide Wonder", "Wireless Web World", "Web World Wide"],
                answer: "World Wide Web"
            },
            {
                question: "An integrated circuit (IC) is commonly known as a:",
                options: ["Microchip", "Transistor", "Resistor", "Diode"],
                answer: "Microchip"
            },
            {
                question: "Which device is a common example of both an input and an output device?",
                options: ["Keyboard", "Printer", "Touchscreen", "Mouse"],
                answer: "Touchscreen"
            },
            {
                question: "What is a computer virus?",
                options: ["A hardware component", "A type of firewall", "A malicious software program", "An operating system"],
                answer: "A malicious software program"
            },
            {
                question: "What is the binary equivalent of the decimal number 5?",
                options: ["110", "101", "011", "100"],
                answer: "101"
            },
            {
                question: "A network that connects devices within a limited area, like a home or office, is a:",
                options: ["WAN (Wide Area Network)", "MAN (Metropolitan Area Network)", "LAN (Local Area Network)", "SAN (Storage Area Network)"],
                answer: "LAN (Local Area Network)"
            },
            {
                question: "What is the standard protocol used for sending and receiving emails?",
                options: ["HTTP", "FTP", "SMTP", "TCP/IP"],
                answer: "SMTP"
            },
            {
                question: "Which technology is used for wireless communication over short distances?",
                options: ["Infrared", "Bluetooth", "Wi-Fi", "Cellular"],
                answer: "Bluetooth"
            },
            {
                question: "What is a pixel?",
                options: ["A unit of data storage", "The smallest unit of an image", "A type of computer program", "A networking protocol"],
                answer: "The smallest unit of an image"
            },
            {
                question: "What is a computer mouse used for?",
                options: ["Text input", "Audio output", "Screen navigation and pointer control", "Printing documents"],
                answer: "Screen navigation and pointer control"
            },
            {
                question: "Which of the following is a function of the BIOS?",
                options: ["To launch the web browser", "To manage system storage", "To load the operating system", "To play video games"],
                answer: "To load the operating system"
            },
            {
                question: "A gigabyte is approximately equal to:",
                options: ["1024 bytes", "1024 kilobytes", "1024 megabytes", "1024 gigabytes"],
                answer: "1024 megabytes"
            }
        ];

        const welcomeScreen = document.getElementById('welcome-screen');
        const userNameInput = document.getElementById('user-name-input');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const quizContent = document.getElementById('quiz-content');

        const quizForm = document.getElementById('quiz-form');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const resultsDiv = document.getElementById('results');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const obtainedMarksSpan = document.getElementById('obtained-marks');
        const incorrectList = document.getElementById('incorrect-list');
        const countdownTimerDisplay = document.getElementById('countdown-timer');
        const printResultsBtn = document.getElementById('print-results-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const scrollButton = document.getElementById('scroll-button');
        const scrollIcon = document.getElementById('scroll-icon');
        const printableResultsImageDiv = document.getElementById('printable-results-image');

        // New elements for explanation modal
        const explanationModal = document.getElementById('explanation-modal');
        const closeExplanationModalBtn = document.getElementById('close-explanation-modal');
        const explanationTitle = document.getElementById('explanation-title');
        const explanationContent = document.getElementById('explanation-content');
        const explanationLoading = document.getElementById('explanation-loading');

        let userName = ''; // To store the user's name
        let timerInterval; // Variable to hold the timer interval
        const quizDuration = 30 * 60; // 30 minutes in seconds

        /**
         * Displays a custom message box instead of using alert().
         * @param {string} message - The message to display.
         */
        function showCustomMessage(message) {
            messageText.textContent = message;
            messageBox.style.display = 'block';
        }

        /**
         * Shuffles an array in place using the Fisher-Yates (Knuth) shuffle algorithm.
         * @param {Array} array - The array to shuffle.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
        }

        /**
         * Starts the countdown timer for the quiz.
         * @param {number} duration - The total duration of the quiz in seconds.
         * @param {HTMLElement} display - The HTML element to display the timer.
         */
        function startTimer(duration, display) {
            let timer = duration;
            let minutes, seconds;

            timerInterval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    submitQuiz(true); // Submit quiz automatically if time runs out
                    showCustomMessage("Time's up! Your quiz has been submitted automatically.");
                }
            }, 1000);
        }

        /**
         * Displays the quiz questions on the page.
         */
        function displayQuestions() {
            shuffleArray(questions); // Shuffle questions before displaying
            quizForm.innerHTML = ''; // Clear any existing questions

            questions.forEach((q, index) => {
                const questionBox = document.createElement('div');
                questionBox.className = 'bg-white p-6 rounded-lg shadow-md border border-gray-200'; // Boxed layout
                questionBox.id = `question-${index + 1}`; // Unique ID for each question box

                const questionText = document.createElement('p');
                questionText.className = 'question-text mb-4'; // Custom styling for question text
                questionText.innerHTML = `${index + 1}. ${q.question}`; // Use innerHTML for subscripts
                questionBox.appendChild(questionText);

                // Shuffle options for each question
                const shuffledOptions = [...q.options];
                shuffleArray(shuffledOptions);

                shuffledOptions.forEach((option, optionIndex) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'mb-2';

                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `question${index}`; // Group radio buttons for each question
                    input.id = `q${index}-option${optionIndex}`;
                    input.value = option;
                    input.className = 'option-input'; // Hidden input

                    const label = document.createElement('label');
                    label.htmlFor = `q${index}-option${optionIndex}`;
                    label.className = 'option-label'; // Styled label
                    label.innerHTML = option; // Use innerHTML for subscripts in options

                    optionDiv.appendChild(input);
                    optionDiv.appendChild(label);
                    questionBox.appendChild(optionDiv);
                });

                quizForm.appendChild(questionBox);
            });
        }

        /**
         * Handles the quiz submission logic.
         * @param {boolean} [timedOut=false] - True if the quiz was submitted due to time running out.
         */
        function submitQuiz(timedOut = false) {
            clearInterval(timerInterval); // Stop the timer

            let score = 0;
            const incorrectAnswers = [];
            let allAnswered = true;

            questions.forEach((q, index) => {
                const questionName = `question${index}`;
                const selectedOption = document.querySelector(`input[name="${questionName}"]:checked`);

                if (!selectedOption) {
                    allAnswered = false;
                    // Highlight unanswered question (optional, but good for UX)
                    const questionBox = document.getElementById(`question-${index + 1}`);
                    if (questionBox) {
                        questionBox.style.border = '2px solid #ef4444'; // Red border for unanswered
                        questionBox.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Scroll to it
                    }
                    return; // Skip to next question if not answered
                } else {
                     // Reset border if previously highlighted
                    const questionBox = document.getElementById(`question-${index + 1}`);
                    if (questionBox) {
                        questionBox.style.border = '1px solid #cbd5e0';
                    }
                }

                if (selectedOption.value === q.answer) {
                    score++;
                } else {
                    incorrectAnswers.push({
                        serial: index + 1,
                        question: q.question,
                        correctAnswer: q.answer
                    });
                }
            });

            if (!allAnswered && !timedOut) {
                showCustomMessage("Please attempt all questions before submitting the quiz.");
                return; // Prevent submission if not all questions are answered
            }

            // Display results
            resultsDiv.classList.remove('hidden');
            totalQuestionsSpan.textContent = questions.length;
            obtainedMarksSpan.textContent = `${score} / ${questions.length}`;

            incorrectList.innerHTML = ''; // Clear previous incorrect answers
            if (incorrectAnswers.length > 0) {
                incorrectAnswers.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        Question <strong class="text-red-600">${item.serial}</strong>:
                        <span class="text-blue-700 block mt-1">${item.question}</span>
                        Correct Answer: <span class="text-blue-700 font-semibold">${item.correctAnswer}</span>
                        <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-full ml-2 mt-1"
                                onclick="getExplanation('${encodeURIComponent(item.question)}', '${encodeURIComponent(item.correctAnswer)}', this)">
                            ✨ Explain
                        </button>
                    `;
                    incorrectList.appendChild(listItem);
                });
                document.getElementById('incorrect-answers').classList.remove('hidden');
            } else {
                // Hide the incorrect answers section if all are correct
                document.getElementById('incorrect-answers').classList.add('hidden');
                const allCorrectMessage = document.createElement('p');
                allCorrectMessage.className = 'text-green-700 font-bold text-center text-lg';
                allCorrectMessage.textContent = "Congratulations! All your answers are correct!";
                incorrectList.appendChild(allCorrectMessage);
            }

            // Disable submit button after submission
            submitQuizBtn.disabled = true;
            submitQuizBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * Displays the explanation modal.
         * @param {string} title - The title for the explanation modal.
         * @param {string} content - The explanation content.
         */
        function showExplanationModal(title, content) {
            explanationTitle.textContent = title;
            explanationContent.innerHTML = content;
            explanationModal.style.display = 'flex';
        }

        /**
         * Hides the explanation modal.
         */
        function hideExplanationModal() {
            explanationModal.style.display = 'none';
            explanationContent.innerHTML = ''; // Clear content
        }

        /**
         * Fetches an explanation for a given question and correct answer using Gemini API.
         * @param {string} encodedQuestion - The URI-encoded question text.
         * @param {string} encodedCorrectAnswer - The URI-encoded correct answer.
         * @param {HTMLElement} buttonElement - The button element that triggered the explanation.
         */
        async function getExplanation(encodedQuestion, encodedCorrectAnswer, buttonElement) {
            const question = decodeURIComponent(encodedQuestion);
            const correctAnswer = decodeURIComponent(encodedCorrectAnswer);

            buttonElement.disabled = true;
            buttonElement.textContent = 'Loading...';
            explanationLoading.style.display = 'flex';
            explanationModal.style.display = 'flex'; // Show modal with loading spinner immediately

            let chatHistory = [];
            const prompt = `Explain why '${question}' has '${correctAnswer}' as the correct answer. Provide a detailed but concise explanation suitable for a Bachelor-level computer science student.`;
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            const apiKey = ""; // If you want to use models other than gemini-2.5-flash-preview-05-20 or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let responseText = "Failed to get explanation. Please try again.";
            let retries = 0;
            const maxRetries = 3;
            let delay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // If response is not OK, it might be a rate limit or other error
                        if (response.status === 429) { // Too Many Requests
                            retries++;
                            delay *= 2; // Exponential backoff
                            await new Promise(res => setTimeout(res, delay));
                            continue; // Retry
                        } else {
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        responseText = result.candidates[0].content.parts[0].text;
                    } else {
                        responseText = "No explanation found or unexpected response format.";
                    }
                    break; // Exit loop on success
                } catch (error) {
                    console.error("Error fetching explanation:", error);
                    retries++;
                    delay *= 2; // Exponential backoff
                    if (retries < maxRetries) {
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        responseText = `An error occurred: ${error.message}. Please try again later.`;
                    }
                }
            }

            explanationLoading.style.display = 'none';
            showExplanationModal(`Explanation for Question ${buttonElement.closest('li').querySelector('strong').textContent.split(':')[0]}`, responseText);
            buttonElement.disabled = false;
            buttonElement.textContent = '✨ Explain';
        }


        /**
         * Handles printing the quiz results as an image.
         */
        async function printResults() {
            // Populate the hidden div with content for the image
            const headerContent = `
                <div class="header-content">
                    <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 5px; font-family: 'Inter', sans-serif;">SST TESTs PREPARATION</h1>
                    <p style="font-size: 0.9rem; margin-bottom: 3px; font-family: 'Inter', sans-serif;">By Imran Ustad</p>
                    <p style="font-size: 0.9rem; margin-bottom: 3px; font-family: 'Inter', sans-serif;">YouTube : Imran Ustad</p>
                    <p style="font-size: 0.9rem; font-family: 'Inter', sans-serif;">WhatsApp : 03345501369</p>
                </div>
            `;

            const resultsSummaryContent = `
                <div class="results-summary" style="padding: 20px;">
                    <p class="user-name-display" style="font-family: 'Inter', sans-serif;">Student: ${userName}</p>
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Quiz Results</h2>
                    <p style="margin-bottom: 5px;">Total Questions: <strong style="color: #16a34a;">${questions.length}</strong></p>
                    <p>Obtained Marks: <strong style="color: #16a34a;">${obtainedMarksSpan.textContent}</strong></p>
                </div>
            `;

            const currentDateTime = new Date().toLocaleString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: true
            });
            const dateTimeContent = `<div class="date-time" style="font-family: 'Inter', sans-serif;">${currentDateTime}</div>`;

            const footerContent = `
                <div class="footer-content" style="margin-top: 20px;">
                    <h3 style="font-size: 1rem; font-weight: bold; margin-bottom: 5px; font-family: 'Inter', sans-serif;">By Imran Ustad</h3>
                    <p style="font-size: 0.8rem; margin-bottom: 3px; font-family: 'Inter', sans-serif;">YouTube : Imran Ustad</p>
                    <p style="font-size: 0.8rem; font-family: 'Inter', sans-serif;">WhatsApp : 03345501369</p>
                </div>
            `;

            printableResultsImageDiv.innerHTML = `
                ${headerContent}
                ${resultsSummaryContent}
                ${dateTimeContent}
                ${footerContent}
            `;

            // Use html2canvas to capture the content
            try {
                const canvas = await html2canvas(printableResultsImageDiv, {
                    scale: 2, // Increase scale for better resolution
                    useCORS: true, // Enable cross-origin image loading if any
                    logging: false // Disable logging for cleaner console
                });

                // Create an image URL from the canvas
                const imageUrl = canvas.toDataURL('image/png'); // Can be 'image/jpeg'

                // Create a temporary link and trigger download
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `Quiz_Results_${userName.replace(/\s/g, '_')}.png`; // File name includes user's name
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Clear the hidden div after generating the image
                printableResultsImageDiv.innerHTML = '';

            } catch (error) {
                console.error("Error generating image:", error);
                showCustomMessage("Failed to generate image. Please try again.");
            }
        }

        /**
         * Updates the scroll button text and function based on scroll position.
         */
        function updateScrollButton() {
            // Check if user is near the bottom of the page
            const isNearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 100); // 100px buffer

            if (window.scrollY > 100 && !isNearBottom) { // If scrolled down and not near bottom
                scrollIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />`; // Up arrow
                scrollButton.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (isNearBottom) { // If near bottom
                scrollIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />`; // Up arrow
                scrollButton.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            else { // Near top
                scrollIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />`; // Down arrow
                scrollButton.onclick = () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        }

        /**
         * Attaches all necessary event listeners.
         * This is called on initial load and after printResults to re-attach.
         */
        function attachEventListeners() {
            submitQuizBtn.addEventListener('click', () => submitQuiz(false));
            printResultsBtn.addEventListener('click', printResults);
            closeExplanationModalBtn.addEventListener('click', hideExplanationModal); // Close modal button
            window.addEventListener('scroll', updateScrollButton);
            updateScrollButton(); // Call once on load to set initial state
        }

        // Initialize quiz on window load
        window.onload = function () {
            // Event listener for the start quiz button
            startQuizBtn.addEventListener('click', () => {
                const name = userNameInput.value.trim();
                if (name) {
                    userName = name;
                    welcomeScreen.style.display = 'none'; // Hide welcome screen
                    quizContent.style.display = 'block'; // Show quiz content
                    displayQuestions(); // Display quiz questions
                    startTimer(quizDuration, countdownTimerDisplay); // Start the timer
                    attachEventListeners(); // Attach other quiz event listeners
                } else {
                    showCustomMessage("Please enter your name to start the quiz.");
                }
            });
        };
    </script>
</body>
</html>